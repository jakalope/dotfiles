#!/bin/bash

a=''
b=''
c=''

curr_branch=$(hg branch)
spec_branch="${1}"
shift

hg diff -r "${spec_branch}" $@ | grep -v '... /dev/null' | grep '^\(---\|+++\)' | while read line
do
    c="${b}"
    b="${a}"
    a="${line}"
    aa=(${a})
    bb=(${b})
    cc=(${c})
    if [[ "${aa[1]:1}" != "${bb[1]:1}" && "${bb[1]:1}" != "${cc[1]:1}" ]]
    then
        if [[ ${bb[0]} == '---' ]]
        then
            echo $b | sed "s/^---/${spec_branch}/g" | awk '{print $1 " " $2}' | ccat.sh 0 
        else
            echo $b | sed "s/^+++/${curr_branch}/g" | awk '{print $1 " " $2}' | ccat.sh 1 
        fi
    fi
done
