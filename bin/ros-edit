#!/bin/bash

if [[ $# == 0 ]]; then
    WORKSPACE="pjfa"         # Use the default workspace
else
    WORKSPACE="$1"          # User has speicified a workspace
fi

WORKSPACE=$(echo $WORKSPACE | sed 's:/$::g') # Remove trailing slash
WORKSPACE_DIR=$(pwd)/${WORKSPACE}

# convert to uppercase for compatibility with vim servernames
WORKSPACE=${WORKSPACE^^} 
SOURCE_DIR=${WORKSPACE_DIR}/src

export ROS_EDIT=1

tmux has-session -t $WORKSPACE &> /dev/null
if [[ $? != 0 ]]; then
    ROS_PACKAGE_PATH=''
    CMAKE_PREFIX_PATH=''
    export temporary_bashrc=$(mktemp)
    chmod 0600 ${temporary_bashrc} # make it secure

    source /opt/ros/${ros_dist}/setup.bash
    BASIC_ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH
    source ${WORKSPACE_DIR}/devel/setup.bash
    ROS_PACKAGE_PATH=${SOURCE_DIR}:$BASIC_ROS_PACKAGE_PATH

    source ~/workspace/utils/setup.sh
    export_command="export CMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}; \
                    export ROS_PACKAGE_PATH=${ROS_PACKAGE_PATH}; \
                    export WORKSPACE=${WORKSPACE}; \
                    export WORKSPACE_DIR=${WORKSPACE_DIR}; \
                    export SOURCE_DIR=${SOURCE_DIR}; \
                    export VIMSERVER=${WORKSPACE}; \
                    alias bash='bash --rcfile ${temporary_bashrc}'; \
                    alias term='gnome-terminal --command=\"bash --rcfile ${temporary_bashrc}\"'; \
                    alias pane='tmux split-window -v \"bash --rcfile ${temporary_bashrc} -i\"'; \
                    alias wcd='cd ${WORKSPACE_DIR}'; \
                    alias scd='cd ${SOURCE_DIR}'"
    cd_command="cd ${WORKSPACE_DIR}"

    # build temp bashrc file
    cp ~/.bashrc $temporary_bashrc
    echo "$export_command" >> $temporary_bashrc
    echo "$cd_command" >> $temporary_bashrc 

    # build vim pane command
    vim_command="${export_command}; cd ${SOURCE_DIR}; vims"

    # start up a tmux session
    tmux new-session -s $WORKSPACE -n ${WORKSPACE} -d "${vim_command}"
    tmux split-window -h "bash --rcfile ${temporary_bashrc} -i"
    tmux split-window -v "bash --rcfile ${temporary_bashrc} -i"
    tmux resize-pane -L 10
    tmux resize-pane -D 25
    tmux select-pane -t 0

    cd ${SOURCE_DIR}
    gen_cscope_db.bash ${WORKSPACE} &
    gen_ctags_db.bash ${WORKSPACE} &
    cd ${WORKSPACE_DIR}
fi

tmux attach -t $WORKSPACE

# cleanup
rm ${temporary_bashrc}
if [[ $(jobs | wc -l) > 0 ]]; then
    kill %%
fi
